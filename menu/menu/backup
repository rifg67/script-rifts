#!/bin/bash
# My Telegram : https://t.me/frel01

# =============== WARNA ===============
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
nama=$(cat /etc/xray/username)

# =============== KONFIG TELEGRAM ===============
KEY=$(grep -E "^#bot# " "/etc/bot/.bot.db" | head -n1 | cut -d ' ' -f 2)
CHATIDS=$(grep -E "^#bot# " "/etc/bot/.bot.db" | cut -d ' ' -f 3)

# =============== KONFIG GITHUB ===============
GITHUB_USER="p3yx"
GITHUB_REPO="backups"
BRANCH="main"
TOKEN_FILE="/etc/bot/.github_token"

if [[ ! -f "$TOKEN_FILE" ]]; then
    mkdir -p /etc/bot
    echo "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" > "$TOKEN_FILE"
    chmod 600 "$TOKEN_FILE"
fi
GITHUB_TOKEN=$(cat "$TOKEN_FILE")

# =============== FOLDER BACKUP ===============
BACKUP_DIR="/root/backups"
mkdir -p "$BACKUP_DIR"

# =============== INFO VPS ===============
IP=$(curl -sS ipv4.icanhazip.com)
domain=$(cat /etc/xray/domain 2>/dev/null || echo "N/A")
date=$(date +"%Y-%m-%d_%H-%M-%S")
BACKUP_ID=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 15 | head -n 1)
zipname="$BACKUP_DIR/$BACKUP_ID.zip"

# ======================= PROSES BACKUP =======================
clear
echo -e "${CYAN}ğŸ”„ Mohon tunggu, proses backup sedang berlangsung...${NC}"
echo -e "${GREEN}ğŸ“‹ ID Backup: $BACKUP_ID${NC}"

rm -rf /root/backup
mkdir -p /root/backup/qt

# Copy file penting (sama seperti sebelumnya)
cp /etc/passwd /root/backup/
cp /etc/group /root/backup/
cp /etc/shadow /root/backup/
cp /etc/gshadow /root/backup/
cp /etc/crontab /root/backup/
cp /etc/vmess/.vmess.db /root/backup/ 2>/dev/null
cp /etc/ssh/.ssh.db /root/backup/ 2>/dev/null
cp /etc/vless/.vless.db /root/backup/ 2>/dev/null
cp /etc/trojan/.trojan.db /root/backup/ 2>/dev/null
cp /etc/bot/.bot.db /root/backup/ 2>/dev/null
cp -r /etc/kyt/limit /root/backup/ 2>/dev/null
cp -r /etc/limit /root/backup/qt/ 2>/dev/null
cp -r /etc/vmess /root/backup/ 2>/dev/null
cp -r /etc/trojan /root/backup/ 2>/dev/null
cp -r /etc/vless /root/backup/ 2>/dev/null
cp -r /etc/slowdns /root/backup/ 2>/dev/null
cp -r /var/lib/kyt/ /root/backup/kyt 2>/dev/null
cp -r /etc/xray /root/backup/xray 2>/dev/null
cp -r /var/www/html/ /root/backup/html 2>/dev/null

if [[ -f "/root/botsell/sellvpn.db" ]]; then
    cp /root/botsell/sellvpn.db /root/backup/
fi

# Buat metadata file dengan info backup
cat > /root/backup/backup_info.txt << EOF
BACKUP_ID=$BACKUP_ID
IP=$IP
DOMAIN=$domain
DATE=$date
TIMESTAMP=$(date +%s)
EOF

# Buat zip
cd /root
zip -r "$zipname" backup > /dev/null 2>&1
rm -rf /root/backup

# ======================= UPLOAD KE GITHUB =======================
echo -e "${BLUE}â¬†ï¸  Proses backup file...${NC}"

UPLOAD_URL="https://api.github.com/repos/$GITHUB_USER/$GITHUB_REPO/contents/$BACKUP_ID.zip"
CHECK_RESPONSE=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
    "https://api.github.com/repos/$GITHUB_USER/$GITHUB_REPO/contents/$BACKUP_ID.zip?ref=$BRANCH")

SHA=$(echo "$CHECK_RESPONSE" | grep -o '"sha": *"[^"]*"' | cut -d'"' -f4)

tmpfile=$(mktemp)
if [[ -n "$SHA" ]]; then
    echo "{\"message\":\"backup $date - ID: $BACKUP_ID\",\"branch\":\"$BRANCH\",\"content\":\"$(base64 -w 0 "$zipname")\",\"sha\":\"$SHA\"}" > "$tmpfile"
else
    echo "{\"message\":\"backup $date - ID: $BACKUP_ID\",\"branch\":\"$BRANCH\",\"content\":\"$(base64 -w 0 "$zipname")\"}" > "$tmpfile"
fi

RESPONSE=$(curl -s -X PUT -H "Authorization: token $GITHUB_TOKEN" \
    -H "Content-Type: application/json" \
    --data-binary @"$tmpfile" \
    "$UPLOAD_URL")

rm -f "$tmpfile"

if [[ -n "$(echo "$RESPONSE" | grep '"content"')" ]]; then
    echo -e "${GREEN}âœ… Backup berhasil.${NC}"
    echo -e "${GREEN}ğŸ˜ Script by $nama${NC}"
else
    echo -e "${RED}âŒ Upload gagal.${NC}"
    echo "Response: $RESPONSE"
    exit 1
fi

# ======================= NOTIF TELEGRAM =======================
MSG="âš ï¸ *BACKUP VPS SELESAI* âš ï¸
ğŸ“Œ *IP VPS:* \`$IP\`
ğŸŒ *Domain:* \`$domain\`
ğŸ“… *Tanggal:* \`$date\`
ğŸ”‘ *ID Backup:* \`$BACKUP_ID\`

*Gunakan ID di atas untuk restore data*"

for CHATID in $CHATIDS; do
    curl -s -o /dev/null -X POST "https://api.telegram.org/bot$KEY/sendMessage" \
         -d "chat_id=$CHATID" \
         -d "text=$MSG" \
         -d "parse_mode=Markdown"
done

# ======================= TAMPILKAN INFO =======================
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ… BACKUP BERHASIL DIBUAT${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}ğŸ”‘ ID Backup: $BACKUP_ID${NC}"
echo -e "${GREEN}ğŸ“… Tanggal: $date${NC}"
echo -e "${GREEN}ğŸŒ Domain: $domain${NC}"
echo -e "${GREEN}ğŸ“¡ IP: $IP${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}Gunakan ID di atas untuk restore data${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

rm -f "$zipname"
echo -e "${GREEN}âœ… Backup berhasil disimpan dengan ID: $BACKUP_ID${NC}"