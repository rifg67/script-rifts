#!/bin/bash
CONF_FILE="/etc/sysctl.conf"

# --- Konfigurasi Telegram ---
BOT_TOKEN="7916829256:AAHB-_Jv24fTQfR98HA6eNogR8zzYzChw6g" # Ganti dengan Bot Token kamu
CHAT_ID="7661292905"       # Ganti dengan Chat ID kamu

# Variabel untuk log
LOG="ðŸš€ <b>Log Optimasi Sysctl</b>%0AFile: <code>$CONF_FILE</code>%0ATanggal: $(date '+%Y-%m-%d %H:%M:%S')%0A%0A"

# Fungsi animasi loading
loading() {
    local message="$1"
    echo -ne "â³ $message"
    for i in {1..3}; do
        echo -ne "."
        sleep 0.3
    done
    echo -e " âœ…"
    LOG+="â³ $message âœ…%0A"
}

# Notif Telegram
send_telegram() {
    local text="$1"
    curl -s -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMessage" \
        -d chat_id="$CHAT_ID" \
        -d text="$text" \
        -d parse_mode="HTML" >/dev/null
}

echo "ðŸ” Mengecek dan mengoptimalkan $CONF_FILE..."

# Loading proses hapus duplikat
loading "Menghapus duplikat konfigurasi"
TMP_FILE=$(mktemp)
awk '!seen[$1]++' "$CONF_FILE" > "$TMP_FILE"
mv "$TMP_FILE" "$CONF_FILE"

# Tambahkan / update setting optimal
declare -A settings=(
    ["fs.file-max"]="65535"
    ["net.netfilter.nf_conntrack_max"]="262144"
    ["net.netfilter.nf_conntrack_tcp_timeout_time_wait"]="30"
    ["net.core.default_qdisc"]="fq"
    ["net.ipv4.tcp_congestion_control"]="bbr"
    ["net.core.rmem_max"]="67108864"
    ["net.core.wmem_max"]="67108864"
    ["net.core.rmem_default"]="262144"
    ["net.core.wmem_default"]="262144"
    ["net.core.netdev_max_backlog"]="250000"
    ["net.core.somaxconn"]="4096"
    ["net.ipv4.tcp_syncookies"]="1"
    ["net.ipv4.tcp_tw_reuse"]="1"
    ["net.ipv4.tcp_fin_timeout"]="30"
    ["net.ipv4.tcp_keepalive_time"]="1200"
    ["net.ipv4.ip_local_port_range"]="10000 65000"
    ["net.ipv4.tcp_max_syn_backlog"]="8192"
    ["net.ipv4.tcp_max_tw_buckets"]="5000"
    ["net.ipv4.tcp_fastopen"]="3"
    ["net.ipv4.tcp_mem"]="25600 51200 102400"
    ["net.ipv4.tcp_rmem"]="4096 87380 67108864"
    ["net.ipv4.tcp_wmem"]="4096 65536 67108864"
    ["net.ipv4.tcp_mtu_probing"]="1"
    ["net.ipv4.ip_forward"]="1"
    ["net.ipv4.conf.all.rp_filter"]="0"
    ["net.ipv4.conf.default.rp_filter"]="0"
)

for key in "${!settings[@]}"; do
    loading "Optimize $key"
    if grep -q "^$key" "$CONF_FILE"; then
        sed -i "s|^$key.*|$key = ${settings[$key]}|" "$CONF_FILE"
    else
        echo "$key = ${settings[$key]}" >> "$CONF_FILE"
    fi
done

# Apply perubahan
loading "Menerapkan perubahan sysctl"
sysctl -p >/dev/null 2>&1

echo "âœ… Optimasi sysctl selesai."
LOG+="âœ… Optimasi sysctl selesai%0A"

# Kirim semua log ke Telegram
send_telegram "$LOG"
