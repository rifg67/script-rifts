#!/bin/bash
# Script Restore Backup dari GitHub (Tanpa Token)

# =============== WARNA ===============
RED='\033[0;31m'
NC='\033[0m'
GREEN='\033[0;32m'
CYAN='\033[0;36m'
BLUE='\033[0;34m'
nama=$(cat /etc/xray/username)

# =============== KONFIG GITHUB ===============
GITHUB_USER="p3yx"
GITHUB_REPO="backups"
BRANCH="main"

# =============== SETUP AWAL ===============
clear
echo -e "${CYAN}ðŸ”„ Memulai proses restore...${NC}"
echo -e "${GREEN}ðŸ˜Ž Script by $nama ${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"

# Cek dependency
if ! command -v curl &> /dev/null; then
    echo -e "${BLUE}ðŸ“¦ Installing curl...${NC}"
    apt-get update && apt-get install -y curl
fi

if ! command -v unzip &> /dev/null; then
    echo -e "${BLUE}ðŸ“¦ Installing unzip...${NC}"
    apt-get install -y unzip
fi

# Minta input ID Backup
echo -e "${GREEN}ðŸ“ Masukkan ID Backup yang ingin di-restore:${NC}"
read -p "ID Backup (15 karakter): " BACKUP_ID

if [[ -z "$BACKUP_ID" ]]; then
    echo -e "${RED}âŒ ID Backup tidak boleh kosong!${NC}"
    exit 1
fi

if [[ ${#BACKUP_ID} -ne 15 ]]; then
    echo -e "${RED}âŒ ID Backup harus 15 karakter!${NC}"
    exit 1
fi

# ======================= DOWNLOAD DARI GITHUB =======================
echo -e "${BLUE}â¬‡ï¸ Mendownload file backup...${NC}"

DOWNLOAD_URL="https://raw.githubusercontent.com/$GITHUB_USER/$GITHUB_REPO/$BRANCH/$BACKUP_ID.zip"

# Download file
echo -e "${GREEN}ðŸ“¥ Mendownload backup...${NC}"
curl -s -L -o "/tmp/$BACKUP_ID.zip" "$DOWNLOAD_URL"

# Cek jika download berhasil
if [[ $? -ne 0 ]] || [[ ! -f "/tmp/$BACKUP_ID.zip" ]]; then
    echo -e "${RED}âŒ Gagal mendownload backup!${NC}"
    echo -e "${RED}âš ï¸ Pastikan ID backup benar dan file tersedia di GitHub${NC}"
    exit 1
fi

# Cek file size
FILESIZE=$(stat -c%s "/tmp/$BACKUP_ID.zip")
if [[ $FILESIZE -lt 1000 ]]; then
    echo -e "${RED}âŒ File backup terlalu kecil, mungkin tidak valid!${NC}"
    rm -f "/tmp/$BACKUP_ID.zip"
    exit 1
fi

echo -e "${GREEN}âœ… Download berhasil!${NC}"
echo -e "${GREEN}ðŸ“¦ Ukuran file: $(($FILESIZE/1024)) KB${NC}"

# ======================= PROSES RESTORE =======================
echo -e "${GREEN}ðŸ“¦ Mengekstrak backup...${NC}"

# Buat folder restore
RESTORE_DIR="/root/restore"
rm -rf "$RESTORE_DIR"
mkdir -p "$RESTORE_DIR"

# Extract zip
unzip -q "/tmp/$BACKUP_ID.zip" -d "$RESTORE_DIR"

if [[ $? -ne 0 ]]; then
    echo -e "${RED}âŒ File backup corrupt atau invalid!${NC}"
    echo -e "${RED}âš ï¸ Mungkin file zip rusak atau format tidak sesuai${NC}"
    rm -f "/tmp/$BACKUP_ID.zip"
    exit 1
fi

# Baca info backup
if [[ -f "$RESTORE_DIR/backup/backup_info.txt" ]]; then
    source "$RESTORE_DIR/backup/backup_info.txt"
    echo -e "${GREEN}ðŸ“‹ Info Backup:${NC}"
    echo -e "ðŸ”‘ ID: $BACKUP_ID"
    echo -e "ðŸ“¡ IP VPS: $IP"
    echo -e "ðŸŒ Domain: $DOMAIN"
    echo -e "ðŸ“… Tanggal: $DATE"
    echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
fi

# ======================= RESTORE FILE =======================
echo -e "${GREEN}ðŸ”„ Merestore file...${NC}"

# Restore file penting dengan backup
cp "$RESTORE_DIR/backup/passwd" /etc/ 2>/dev/null
cp "$RESTORE_DIR/backup/group" /etc/ 2>/dev/null
cp "$RESTORE_DIR/backup/shadow" /etc/ 2>/dev/null
cp "$RESTORE_DIR/backup/gshadow" /etc/ 2>/dev/null
cp "$RESTORE_DIR/backup/crontab" /etc/ 2>/dev/null

# Restore config files
mkdir -p /etc/vmess /etc/vless /etc/trojan /etc/ssh /etc/bot /etc/kyt /etc/slowdns /etc/xray

cp "$RESTORE_DIR/backup/vmess.db" /etc/vmess/.vmess.db 2>/dev/null
cp "$RESTORE_DIR/backup/ssh.db" /etc/ssh/.ssh.db 2>/dev/null
cp "$RESTORE_DIR/backup/vless.db" /etc/vless/.vless.db 2>/dev/null
cp "$RESTORE_DIR/backup/trojan.db" /etc/trojan/.trojan.db 2>/dev/null
cp "$RESTORE_DIR/backup/bot.db" /etc/bot/.bot.db 2>/dev/null

# Restore folders
cp -r "$RESTORE_DIR/backup/vmess" /etc/ 2>/dev/null
cp -r "$RESTORE_DIR/backup/trojan" /etc/ 2>/dev/null
cp -r "$RESTORE_DIR/backup/vless" /etc/ 2>/dev/null
cp -r "$RESTORE_DIR/backup/slowdns" /etc/ 2>/dev/null
cp -r "$RESTORE_DIR/backup/xray" /etc/ 2>/dev/null
cp -r "$RESTORE_DIR/backup/kyt" /var/lib/ 2>/dev/null
cp -r "$RESTORE_DIR/backup/html" /var/www/ 2>/dev/null

# Restore limit
if [[ -d "$RESTORE_DIR/backup/limit" ]]; then
    cp -r "$RESTORE_DIR/backup/limit" /etc/ 2>/dev/null
fi

if [[ -d "$RESTORE_DIR/backup/qt/limit" ]]; then
    cp -r "$RESTORE_DIR/backup/qt/limit" /etc/ 2>/dev/null
fi

# Restore sellvpn jika ada
if [[ -f "$RESTORE_DIR/backup/sellvpn.db" ]]; then
    mkdir -p /root/botsell
    cp "$RESTORE_DIR/backup/sellvpn.db" /root/botsell/ 2>/dev/null
fi

# ======================= SELESAI =======================
echo -e "${GREEN}âœ… Restore berhasil!${NC}"
echo -e "${CYAN}ðŸ”„ Restarting services...${NC}"

# Restart services
systemctl restart xray 2>/dev/null
systemctl restart nginx 2>/dev/null
systemctl restart ssh 2>/dev/null
systemctl restart dropbear 2>/dev/null

echo -e "${GREEN}ðŸŽ‰ Semua data berhasil di-restore!${NC}"
echo -e "${CYAN}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${NC}"
echo -e "${GREEN}âœ… Proses restore selesai!${NC}"

# Bersihkan
rm -f "/tmp/$BACKUP_ID.zip"
rm -rf "$RESTORE_DIR" 2>/dev/null