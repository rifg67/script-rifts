#!/bin/bash

# Warna
y='\033[1;93m'; c="\033[0;36m"; g="\e[92;1m"; r="\033[1;31m"; NC='\e[0m'
gray="\e[1;30m"; Blue="\033[1;36m"; GREEN='\033[0;32m'; grenbo="\033[1;95m"
yell='\e[33m'; bc="\e[5;36m"; ungu='\033[0;35m'

# Konfigurasi GitHub dan Telegram
EMAIL="peyxdev@gmail.com"
USER="PeyxDev"
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"
CHATID="7661292905"
KEY="7916829256:AAHB-_Jv24fTQfR98HA6eNogR8zzYzChw6g"
URL="https://api.telegram.org/bot$KEY/sendMessage"
today=$(date +%Y-%m-%d)
REPO_URL="https://$TOKEN@github.com/$USER/PeyxDev.git"

# Cek & Install Dependensi
for pkg in git curl wget; do
  [[ ! -f /usr/bin/$pkg ]] && apt install $pkg -y &>/dev/null
done

# Fungsi Garis & Logo
lane() { echo -e "${bc}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"; }
LOGO() {
  clear
  lane
  echo -e "${ungu}           SCRIPT IZIN VPS           ${NC}"
  lane
}

# Fungsi Animasi Loading
loading() {
  local pesan="$1"
  echo -ne "${y}$pesan${NC}"
  for i in {1..5}; do
    echo -ne "."
    sleep 0.2
  done
  echo ""
}

# Fungsi Notifikasi Telegram
notify_telegram() {
  local msg="$1"
  curl -s --max-time 10 -d "chat_id=$CHATID&disable_web_page_preview=1&text=$msg&parse_mode=html" $URL >/dev/null
}

# List IP VPS
list_ip() {
  LOGO
  loading "Mengambil data IP dari GitHub"
  rm -rf /root/PeyxDev
  git clone -q $REPO_URL /root/PeyxDev
  cd /root/PeyxDev || exit

  if grep -q "^###" ipx; then
    echo ""
    lane
    printf "%-15s %-15s %-15s\n" "USERNAME" "EXPIRED" "IP VPS"
    lane
    grep -E "^###" ipx | awk '{print $2, $3, $4}' | while read -r user exp ip; do
      if [[ $(date -d "$exp" +%s) -lt $(date +%s) ]]; then
        printf "%-15s ${r}%-15s${NC} %-15s\n" "$user" "$exp" "$ip"
      else
        printf "%-15s %-15s %-15s\n" "$user" "$exp" "$ip"
      fi
    done
    lane
  else
    echo -e "${r}Tidak ada data IP terdaftar!${NC}"
  fi
  read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu"
}

# Tambah IP
add_ip() {
  LOGO
  echo -e "${y}Masukkan IP VPS yang akan ditambahkan${NC}"
  read -p "Verifikasi Admin (Password): " pass
  [[ $pass != "peyx" ]] && echo -e "${r}Akses ditolak!${NC}" && exit 1
  
  loading "Mengunduh data repository"
  rm -rf /root/PeyxDev
  git clone -q $REPO_URL /root/PeyxDev
  cd /root/PeyxDev || exit
  
  read -p "IP Address       : " ipqu
  [[ -z "$ipqu" ]] && echo -e "${r}IP tidak boleh kosong!${NC}" && exit 1
  grep -q "$ipqu" ipx && echo -e "${r}IP sudah terdaftar!${NC}" && exit 1
  read -p "Username IP      : " name
  read -p "Masa aktif (hari): " exp

  exp2=$(date -d "$exp days" +%Y-%m-%d)
  echo "### $name $exp2 $ipqu" >> ipx

  git pull -q
  git add ipx && git commit -m "Add IP $ipqu" &>/dev/null
  git push -q origin main

  TEXT="
<code>âœ… IP VPS BERHASIL DITAMBAHKAN</code>
<code>Username  : $name</code>
<code>IP VPS    : $ipqu</code>
<code>Tanggal   : $today</code>
<code>Expired   : $exp2</code>"
  notify_telegram "$TEXT"

  echo -e "${g}SUKSES! IP $ipqu ditambahkan.${NC}"
  read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu"
}

# Hapus IP
delete_ip() {
  LOGO
  echo -e "${y}Masukkan IP VPS yang akan dihapus${NC}"
  read -p "Verifikasi Admin (Password): " pass
  [[ $pass != "peyx" ]] && echo -e "${r}Akses ditolak!${NC}" && exit 1
  
  loading "Mengunduh data repository"
  rm -rf /root/PeyxDev
  git clone -q $REPO_URL /root/PeyxDev
  cd /root/PeyxDev || exit

  grep -E "^###" ipx | awk '{print $2, $3, $4}'
  read -p "IP yang ingin dihapus: " ipdel

  line=$(grep "$ipdel" ipx)
  [[ -z "$line" ]] && echo -e "${r}IP tidak ditemukan!${NC}" && exit 1
  
  name=$(echo "$line" | awk '{print $2}')
  exp=$(echo "$line" | awk '{print $3}')
  sed -i "/$ipdel/d" ipx

  git pull -q
  git add ipx && git commit -m "Delete IP $ipdel" &>/dev/null
  git push -q origin main

  TEXT="
<code>ğŸ—‘ï¸ IP VPS BERHASIL DIHAPUS</code>
<code>Username  : $name</code>
<code>IP VPS    : $ipdel</code>
<code>Expired   : $exp</code>"
  notify_telegram "$TEXT"

  echo -e "${g}SUKSES! IP $ipdel dihapus.${NC}"
  read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu"
}

# Perpanjang IP
renew_ip() {
  LOGO
  echo -e "${y}Perpanjang masa aktif IP VPS${NC}"
  read -p "Verifikasi Admin (Password): " pass
  [[ $pass != "peyx" ]] && echo -e "${r}Akses ditolak!${NC}" && exit 1
  
  loading "Mengunduh data repository"
  rm -rf /root/PeyxDev
  git clone -q $REPO_URL /root/PeyxDev
  cd /root/PeyxDev || exit

  grep -E "^###" ipx | awk '{print $2, $3, $4}'
  read -p "IP yang ingin diperpanjang: " ipqu
  read -p "Tambahan hari aktif       : " days

  line=$(grep "$ipqu" ipx)
  [[ -z "$line" ]] && echo -e "${r}IP tidak ditemukan!${NC}" && exit 1
  
  name=$(echo "$line" | awk '{print $2}')
  old_exp=$(echo "$line" | awk '{print $3}')
  now=$(date +%Y-%m-%d)
  d1=$(date -d "$old_exp" +%s)
  d2=$(date -d "$now" +%s)
  sisa_hari=$(( (d1 - d2) / 86400 ))
  total_hari=$(( sisa_hari + days ))
  new_exp=$(date -d "$total_hari days" +"%Y-%m-%d")

  sed -i "s/$name $old_exp $ipqu/$name $new_exp $ipqu/" ipx

  git pull -q
  git add ipx && git commit -m "Renew IP $ipqu" &>/dev/null
  git push -q origin main

  TEXT="
<code>â™»ï¸ IP VPS DIPERPANJANG</code>
<code>Username  : $name</code>
<code>IP VPS    : $ipqu</code>
<code>Expired   : $new_exp</code>"
  notify_telegram "$TEXT"

  echo -e "${g}SUKSES! IP $ipqu diperpanjang sampai $new_exp.${NC}"
  read -n 1 -s -r -p "Tekan tombol apapun untuk kembali ke menu"
}

# Menu Utama
main_menu() {
  while true; do
    clear
    echo -e " \033[31m##########\033[33m##########\033[32m##########\033[34m##########\033[35m##########\033[36m##########\e[0m"
echo -e " \033[31mâ•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®\e[0m"
echo -e " \033[34mâ”‚$NC\033[33m MENU Github Owner              ${NC}\033[34mâ”‚\e[0m"
echo -e " \033[33mâ•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯\e[0m"
echo -e " \033[32mâ•­â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•®\e[0m"
echo -e " \033[35mâ”‚$NC [01]${NC} \033[0;36m Add IP${NC}"
echo -e " \033[35mâ”‚$NC [02]${NC} \033[0;36m Delete IP ${NC}"
echo -e " \033[35mâ”‚$NC [03]${NC} \033[0;36m Renew IP ${NC}"
echo -e " \033[35mâ”‚$NC [04]${NC} \033[0;36m List IP ${NC}"
echo -e " \033[36mâ•°â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¯\e[0m"
    echo ""
    read -p "Pilih menu: " menu
    case $menu in
      1) add-ip ;;
      2) del-ip ;;
      3) renew-ip ;;
      4) list-ip ;;
      0) exit 0 ;;
      *) echo -e "${r}Pilihan tidak valid!${NC}"; sleep 2 ;;
    esac
  done
}

main_menu
